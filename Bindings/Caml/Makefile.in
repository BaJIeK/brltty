###############################################################################
# BRLTTY - A background process providing access to the console screen (when in
#          text mode) for a blind person using a refreshable braille display.
#
# Copyright (C) 1995-2007 by The BRLTTY Developers.
#
# BRLTTY comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU General Public License, as published by the Free Software
# Foundation.  Please see the file COPYING for details.
#
# Web Page: http://mielke.cc/brltty/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

include $(SRC_TOP)bindings.mk

OCAMLC = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLDEP = @OCAMLDEP@
OCAMLLEX = @OCAMLLEX@
OCAMLYACC = @OCAMLYACC@
OCAMLBEST = @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLLIB = @OCAMLLIB@
OCAMLWEB = @OCAMLWEB@
OCAMLWIN32 = @OCAMLWIN32@
OCAMLFIND = @OCAMLFIND@

lib = brlapi
bclib = $(lib).cma
nclib = $(lib).cmxa
ifeq ($(OCAMLOPT),no)
files = brlapi.cmi $(bclib)
else
files = brlapi.cmi $(bclib) $(nclib)
endif

bcobjects = brlapi_stubs.o constants.cmo brlapi.cmo
ncobjects = brlapi_stubs.o constants.cmx brlapi.cmx

.PHONY: all clean install uninstall

all : $(files)

$(bclib) : $(bcobjects)
#ifeq ($(OCkAMLFIND),no)
	ocamlmklib -o $(lib) $^ -lbrlapi
#else
#	$(OCAMLC) -a -o $@ $^
#endif

$(nclib) : $(ncobjects)
ifeq ($(OCkAMLFIND),no)
	ocamlmklib -o $(lib) $^ -lbrlapi
else
	$(OCAMLOPT) -a -o $@ $^
endif

brlapi.cmi: $(SRC_DIR)/brlapi.mli
	$(OCAMLC) -o $@ -c $(SRC_DIR)/brlapi.mli

brlapi.cmo: $(SRC_DIR)/brlapi.ml brlapi.cmi
	$(OCAMLC) -o $@ -c $(SRC_DIR)/brlapi.ml

brlapi.cmx brlapi.o: $(SRC_DIR)/brlapi.ml brlapi.cmi
	$(OCAMLOPT) -o $@ -c $(SRC_DIR)/brlapi.ml

brlapi_stubs.o: $(SRC_DIR)/brlapi_stubs.c
	$(OCAMLC) -I $(BLD_TOP)$(PGM_DIR) -I $(SRC_TOP)$(PGM_DIR) -c $(SRC_DIR)/brlapi_stubs.c

brlapi.mli : constants.cmi

constants.cmi : constants.ml
	$(OCAMLC) -c $<

constants.cmo : constants.ml
	$(OCAMLC) -c $<

constants.cmx : constants.ml
	$(OCAMLOPT) -c $<

constants.ml: $(CONSTANTS_SCRIPTS) $(CONSTANTS_SOURCES)
	$(AWK) $(CONSTANTS_OPTIONS) $(CONSTANTS_SOURCES) >$@

clean::
	rm -f *.cm* *.a *.so constants.ml

install: all
ifeq ($(OCkAMLFIND),no)
	@echo Can't install OCaml bindings withot findlib; exit 1 
else
	-$(OCAMLFIND) remove $(lib)
	$(OCAMLFIND) install $(lib) META $(files) constants.cmi brlapi.a libbrlapi.a dllbrlapi.so 
endif

uninstall:

