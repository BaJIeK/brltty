###############################################################################
# BRLTTY - A background process providing access to the console screen (when in
#          text mode) for a blind person using a refreshable braille display.
#
# Copyright (C) 1995-2007 by The BRLTTY Developers.
#
# BRLTTY comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU General Public License, as published by the Free Software
# Foundation.  Please see the file COPYING for details.
#
# Web Page: http://mielke.cc/brltty/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

include $(SRC_TOP)bindings.mk

OCAMLC = @OCAMLC@
OCAMLOPT = @OCAMLOPT@
OCAMLMKLIB = @OCAMLMKLIB@
OCAMLMKLIB_FLAGS = -cclib -l$(API_NAME) -ldopt -L$(API_DIR)
OCAMLDEP = @OCAMLDEP@
OCAMLLEX = @OCAMLLEX@
OCAMLYACC = @OCAMLYACC@
OCAMLBEST = @OCAMLBEST@
OCAMLVERSION = @OCAMLVERSION@
OCAMLLIB = @OCAMLLIB@
OCAMLWEB = @OCAMLWEB@
OCAMLWIN32 = @OCAMLWIN32@
OCAMLFIND = @OCAMLFIND@
OCAML_INSTALL_TARGET = @OCAML_INSTALL_TARGET@
OCAML_UNINSTALL_TARGET = @OCAML_UNINSTALL_TARGET@

OCAML_LIB = $(API_NAME)
OCAML_BCLIB = $(OCAML_LIB).cma
OCAML_NCLIB = @OCAML_NCLIB@

OCAML_CONSTANTS = constants

OCAML_MISC = $(SRC_DIR)/META $(SRC_DIR)/brlapi.mli brlapi.cmi $(OCAML_CONSTANTS).cmi

OCAML_CLIBS = @OCAML_CLIBS@

OCAML_FILES = $(OCAML_MISC) $(OCAML_CLIBS) $(OCAML_BCLIB) $(OCAML_NCLIB)

OCAML_BCOBJECTS = $(OCAML_CONSTANTS).cmo brlapi.cmo
OCAML_NCOBJECTS = $(OCAML_BCOBJECTS:.cmo=.cmx)

.PHONY: all clean
.PHONY: install install-with-findlib install-without-findlib
.PHONY: uninstall uninstall-with-findlib uninstall-without-findlib

all : $(OCAML_FILES)

$(OCAML_CLIBS) : brlapi_stubs.o
	$(OCAMLMKLIB) $(API_LDFLAGS) -o $(OCAML_LIB) brlapi_stubs.o

$(OCAML_BCLIB) : $(OCAML_CLIBS) $(OCAML_BCOBJECTS)
	$(OCAMLMKLIB) $(OCAMLMKLIB_FLAGS) -o $(OCAML_LIB) $(OCAML_BCOBJECTS)

$(OCAML_NCLIB) : $(OCAML_CLIBS) $(OCAML_NCOBJECTS)
	$(OCAMLMKLIB) $(OCAMLMKLIB_FLAGS) -o $(OCAML_LIB) $(OCAML_NCOBJECTS)

brlapi.cmi: $(SRC_DIR)/brlapi.mli
	$(OCAMLC) -o $@ -c $(SRC_DIR)/brlapi.mli

brlapi.cmo: $(SRC_DIR)/brlapi.ml brlapi.cmi
	$(OCAMLC) -o $@ -c $(SRC_DIR)/brlapi.ml

brlapi.cmx: $(SRC_DIR)/brlapi.ml brlapi.cmi
	$(OCAMLOPT) -o $@ -c $(SRC_DIR)/brlapi.ml

brlapi_stubs.o: $(SRC_DIR)/brlapi_stubs.c
	$(OCAMLC) -I $(BLD_TOP)$(PGM_DIR) -I $(SRC_TOP)$(PGM_DIR) -c $(SRC_DIR)/brlapi_stubs.c

brlapi.mli : $(OCAML_CONSTANTS).cmi

$(OCAML_CONSTANTS).cmi : $(OCAML_CONSTANTS).ml
	$(OCAMLC) -c $(OCAML_CONSTANTS).ml

$(OCAML_CONSTANTS).cmo : $(OCAML_CONSTANTS).ml
	$(OCAMLC) -c $(OCAML_CONSTANTS).ml

$(OCAML_CONSTANTS).cmx : $(OCAML_CONSTANTS).ml
	$(OCAMLOPT) -c $(OCAML_CONSTANTS).ml

$(OCAML_CONSTANTS).ml: $(CONSTANTS_SCRIPTS) $(CONSTANTS_SOURCES)
	$(AWK) $(CONSTANTS_OPTIONS) $(CONSTANTS_SOURCES) >$@

clean::
	rm -f *.cm* *.a *.so $(OCAML_CONSTANTS).ml

install: all $(OCAML_INSTALL_TARGET)

install-without-findlib:
	@echo Can't install OCaml bindings withot using findlib 

install-with-findlib:
	-$(OCAMLFIND) remove $(OCAML_LIB)
	$(OCAMLFIND) install $(OCAML_LIB) $(OCAML_FILES) 

uninstall: $(OCAML_UNINSTALL_TARGET)

uninstall-without-findlib:

uninstall-with-findlib:
	$(OCAMLFIND) remove $(OCAML_LIB)
