###############################################################################
# BRLTTY - A background process providing access to the console screen (when in
#          text mode) for a blind person using a refreshable braille display.
#
# Copyright (C) 1995-2006 by The BRLTTY Developers.
#
# BRLTTY comes with ABSOLUTELY NO WARRANTY.
#
# This is free software, placed under the terms of the
# GNU General Public License, as published by the Free Software
# Foundation.  Please see the file COPYING for details.
#
# Web Page: http://mielke.cc/brltty/
#
# This software is maintained by Dave Mielke <dave@mielke.cc>.
###############################################################################

include $(SRC_TOP)bindings.mk

PYREXC = @PYREXC@
PYTHON_CPPFLAGS = @PYTHON_CPPFLAGS@
PYTHON_LDFLAGS = @PYTHON_LDFLAGS@
PYTHON_SITE_PKG = @PYTHON_SITE_PKG@
PYREXC_CFLAGS = @PYREXC_CFLAGS@

PYTHON_MODULE = $(API_NAME)
PYTHON_API = $(PYTHON_MODULE).$(LIB_EXT)

all: $(PYTHON_API)

$(PYTHON_API): brlapi.$O brlapi
	$(MKLIB:<name>=brlapi) $@ brlapi.$O $(PYTHON_LDFLAGS) $(API_LDFLAGS)

brlapi.$O: brlapi.auto.c $(API_HDRS)
	$(CC) $(LIBCFLAGS) $(PYREXC_CFLAGS) $(PYTHON_CPPFLAGS) -DBRLAPI_NO_DEPRECATED -o $@ -c brlapi.auto.c

brlapi.auto.c: $(SRC_DIR)/brlapi.pyx $(SRC_DIR)/c_brlapi.pxd constants.auto.pyx
	$(PYREXC) -I. -o $@ $(SRC_DIR)/brlapi.pyx

constants.auto.pyx: $(API_HDR) $(API_AWK) $(BRL_HDR) $(BRL_AWK) $(SRC_DIR)/constants.awk
	$(AWK) -f $(API_AWK) -f $(BRL_AWK) -f $(SRC_DIR)/constants.awk $(API_HDR) $(BRL_HDR) >$@

doc: $(PYTHON_API)
	LD_PRELOAD=$(API_LIB) PYTHONPATH=. pydoc -w $(PYTHON_MODULE)

install: all
	$(INSTALL_DIRECTORY) $(INSTALL_ROOT)$(PYTHON_SITE_PKG)
	$(INSTALL_PROGRAM) $(PYTHON_API) $(INSTALL_ROOT)$(PYTHON_SITE_PKG)

uninstall: $(PYTHON_API)
	-rm -f $(INSTALL_ROOT)$(PYTHON_SITE_PKG)/$(PYTHON_API)

clean::
	-rm -f $(PYTHON_API) *.auto.pyx *.html

